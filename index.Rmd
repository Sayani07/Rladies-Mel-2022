---
title: "Building a new geom in ggplot2"
author: "<br> Sayani Gupta <br> <i class='fab fa-github'></i> Sayani07 &nbsp; &nbsp; <i class='fab fa-twitter' style='color:#6CADDE'></i> SayaniGupta07 <br><font> <small>https://sayanigupta-useR2020.netlify.com/</small>"
email: "Sayani.Gupta@monash.edu"
twitter: "SayaniGupta07"
date:  <font size = "7"> R-Ladies Melbourne
pdflink: ""
bgimg: "images/grey-yellow.png"
output:
  xaringan::moon_reader:
    after_body: ["libs/collapseoutput.js"]
    css:
      - ninjutsu 
      - "assets/animate.css"
      - "assets/monash-logo.css"
      - "assets/monash-brand.css"
      - "assets/monash-fonts.css"
      - "assets/styles.css" # small improvements
      - "assets/custom.css" # add your own CSS here!
      - "assets/demo.css" # this should be removed
      - "timeline.css"
      - "libs/font-awesome/css/fontawesome-all.css"
    # [ "libs/myremark.css", "xaringan-themer.css" , "libs/font-awesome/css/fontawesome-all.css"]
    self_contained: false
    lib_dir: libs
    includes:
      in_header: "assets/custom.html"
    mathjax: "assets/mathjax-local/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
    nature:
      ratio: 16:9
      highlightStyle: solarized-light
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, cache=TRUE,
  dev.args=list(bg=grey(0.9), pointsize=11))

knitr::read_chunk('R/main.R') 
knitr::read_chunk('R/theme.R')
```



```{r load}
```

class: top left

# About me

- Recently graduated from Monash University
- visualizations of probability distribution of large temporal data
- research interest:
- 2nd talk after covid

---

# Data example we will play with


---

# Decomposing (Extension points) a ggplot into its consituents


.checked[ggplot2 creates graphics based on The Grammar of Graphics]

.checked[graphics are built step by step by adding new elements that allows for extensive flexibility and customization of plots]

- Theme
- scales
- positions
- statistics
- geometries
- coordinates
- facets

<!-- - mapping  -->
<!-- - data -->

---

# Many geoms exists, why build a new one?

- Around 47 existing geoms

Gallery for ggplot2 extensions
https://exts.ggplot2.tidyverse.org/gallery/

Extend the functionality of ggplot2:

customize and integrate new graphical elements with existing ggplot2 visualizations, resulting in a broad range of informative graphics

## complete story told my multiple plots


---


# What is the role of Stat in all of this?

- Even though data is tidy, may not represent te values you want to display

- Do not transform your already tidy data so that it contains those values

- pass your original tidy data into ggplot() as in and allow stat_*() functions to apply transformations internally

- stat_* customised for both their geoms and their transformation functions and works similar to geom_*() functions in other regards

- If you want to use a different geom, make sure that your transformation function calculates all the required aesthetics for that geom
---


# Stat and Geom require each other

`stat_*()` and `geom_*()` are simply convenient instances of the layer() function that builds up the layers of ggplot.

> Unfortunately, due to an early design mistake I called these either stat_() or geom_(). A better decision would have been to call them layer_() functions: that’s a more accurate description because every layer involves a stat and a geom.


---


# What is the challenge(s)

- Difficult to understand how ggplot2 translates a plot specification into an image

<!-- - ggplot2 interface is different to the structure of the underlying machinery that makes it work. -->

- connecting the underlying theory of ggplot2 and The ggplot2 API

-  guides on ggplot internals are extremely sparse

- there are no smooth entry points for aspiring developers. Even for experienced users, the sheer scale and foreignness is demotivating.

- Do we patiently wait, relying on the mercy and sacrifice of experienced developers to host webinars, release official guides, and hold our hands through this journey?

Or, make a modest start?





---

# Making a new stat

- benefits of stats is that they are purely about data transformations, which most R users are used to be doing.


- stat is encapsulated in a tiered succession of calls: compute_layer(), compute_panel(), and compute_group()

- Outside of the compute_*() functions, the remaining logic is found in the setup_params() and setup_data() functions

- The setup_params() function receives the parameters given during construction along with the layer data, and returns a modified list of parameters.

- The setup_data() function receives the modified parameters along with the layer data, and returns the modified layer data


 As a rule of thumb, if the stat operates on multiple rows, start by implementing a compute_group() method, and if the stat operates on single rows, implement a compute_panel() method. 
 
 Because we’ve written a new stat, we get a number of features, like scaling and faceting, for free:

---

# Making a new geom

- The layer need to combine the output of multiple geoms

- The geom needs to return grobs not currently available from existing geoms

- collection of grobs rather than a modified data.frame and this is something outside of the comfort zone of many developers

- Still, Apart from the last point above, it is possible to get by without having to think too much about grid and grobs.

- The main functionality of geoms is, like for stats, a tiered succession of calls: draw_layer(), draw_panel(), and draw_group().

- setup_params()+setup_data() 
One note, though, is that setup_data() is called before any position adjustment is done as part of the build step.



---

# First place we are gonna begin
## Each geom layer is a stand-alone function

.pull-left[
```{r, echo = TRUE}
ggplot(faithful, aes(eruptions, waiting)) + 
  geom_point()
```
]

.pull-right[
```{r, echo = TRUE}
geom_point()
```


```{r, echo = TRUE}
str(geom_point())
```


- instance of a "layer" class
- layer consisting of a type of stat, geom and position
- layer is a list of different methods: functions that are defined for the geom_point() layer
]


---
# geom_*() aliases for layer() function

## layer function specifies geom and stat

.pull-left[
.scroll-sign.f5[
.overflow-scroll.h5[

```{r, echo = TRUE}
names(as.list(geom_point()))
```
]]


.scroll-sign.f5[
.overflow-scroll.h5[
```{r echo = TRUE}
ggplot2::layer(
  geom = GeomPoint,
  stat = StatIdentity,
  position = PositionIdentity
)
```
]]

{{content}}
]

.pull-right[

.scroll-sign.f5[
.overflow-scroll.h5[

```{r, echo = TRUE}
ggplot2::layer(
  geom = GeomBoxplot,
  stat = StatBoxplot,
  position = PositionIdentity
)
```

]]


.scroll-sign.f5[
.overflow-scroll.h5[

```{r, echo = TRUE}
geom_boxplot()
```


]]
{{content}}
]

---


# ggproto

basics: 

---

# Subclass an existing class

New ggproto/ Parent ggproto

## Naming scheme

- The convention for class names is to prefix with the parent (or ancestor) ggproto class name and use upper camel case, e.g. GeomPoint

---


# Play with some geom

## Same geom different input expecatations

Show same stat and geoms are different giving it a different geometry
---

# Play with some stat

## Different geom with same input expecatation

Show same stat and geoms are different giving it a different stat

---

# Combine different grobs

An example of this can be seen in geom_smooth() which combines geom_line() and geom_ribbon()



```{r, echo = TRUE}
print(GeomSmooth$draw_group)
```


---

# Structure of ggplot method

Drawing in ggplot2 involves the following steps
```
ggprint <- function(x) {
  data <- ggplot_build(x) .......(1)
  gtable <- ggplot_gtable(data)......(2)
  grid::grid.newpage()
  grid::grid.draw(gtable)......(3)
  return(invisible(x))
}
```

---

# ggbuild -> Build step

ggplot_build(), as discussed above, takes the declarative representation constructed with the public API and augments it by preparing the data for conversion to graphic primitives.

## Data preparation

## Data transformation

## Output

---
# gtable

All drawing is performed by the grid package together with the active graphics device. 

Its job is to convert user data to one or more graphical primitives such as polygons, lines, points, etc and then hand responsibility over to the grid package.

##  Rendering the panels


## Adding guides
---

# Graphing distribution summaries


.left-column[
- several ways to summarize a distribution
- R package ggdist for visualizing distributions and uncertainty
]

.right-column[
```{r allplotspng}
```
]
---
class: top left

# Different summarization expose different features

.left-column[
- Boxplot not suitable for summarizing multi-modal distributions
- often useful to display different summarization in unison
]

.right-column[
```{r question1png}
```
]
---

background-image: url("images/hdr_paper.png")

background-position: center
background-size: contain


---
# Highest Density Region (HDR) plots

<font size = "3.5"> If $f(x)$ is the density function of a random variable $X$, then the 100 $(1 -\alpha)$ HDR is the subset $R(f_\alpha)$ of the sample space of $X$ such that $R(f_\alpha) = \{x: f(x) \geq f_\alpha\}$, where $f_\alpha$ is the largest constant such that $Pr(X \in R(f_\alpha)) \geq 1-\alpha)$.

```{r falpha, out.width="80%"}
```

---
# Graphing HDRs using R package hdrcde

<i><font size = "4"> Data set: Waiting time between eruptions and the duration of the eruption for the Old Faithful geyser in Yellowstone National Park, Wyoming, USA. </font size = "4"></i>

.pull-left[
```r
faithful %>% as_tibble
```

```{r print-data}
```

]

.pull-right[
```{r faithful-density}
```
]

---

# Graphing HDRs using R package hdrcde

```{r hdrcde, out.width="90%"}
```
---

# Developing an extension usually starts with

idea of what to draw!

if you’re just drawing transformed data with pre-existing geom, then you can use a Stat.

What are:
* the geoms
* the stats
* the coord
* the data




---
# Extending ggplot2

- HDR is a novel technique for summarizing distribution for which plotting is not implemented in ggplot2
- ggplot2 creates graphics based on The Grammar of Graphics
- graphics are built step by step by adding new elements that allows for extensive flexibility and customization of plots
- need to extend the functionality of ggplot2

Defining features of a circle??

Always subclass an existing class (make a new stat)

Class construction
data preparation
calculation
requirements

---
class: top left

# Package gghdr

.pull-left[

- implement HDR plots in ggplot2 
- key elements: *geom* and *stats*
- inspired from R package [`hdrcde`](https://pkg.robjhyndman.com/hdrcde/) developed by [Rob
Hyndman](https://robjhyndman.com/)
]


.pull-right[

.animated.bounce[
<img src="images/gghdr_logo.png" height=280px>
]
]


---
# HDR boxplots

.pull-left[
```r
library(hdrcde)
hdr.boxplot(faithful$eruptions) 
```
<br>

```{r hdrcde-boxplot}

```

]

.pull-right[

```r
library(gghdr)
library(ggplot2)
ggplot(faithful, aes(y = eruptions)) +
  geom_hdr_boxplot()
```

```{r geom-hdr-boxplot}
```
]

---

# HDR rug plots and scatter plots


.pull-left[

```r
faithful %>% 
  ggplot(aes(x = waiting, 
             y = eruptions)) + 
  geom_hdr_rug(fill = "blue") + 
  geom_point() 
```

```{r hdr-rug}
```
]

.pull-right[

```r
faithful %>%
  ggplot(aes(x = waiting,
             y = eruptions)) +  
  geom_point(aes(colour =  
  hdr_bin(x = waiting,y = eruptions)))
```
  
```{r hdr-scatter}
```

]
---
class: top left

# Keep combining - HDR box + jitter

.pull-left[

```r
faithful %>% 
 ggplot(aes(y = eruptions)) + 
*geom_hdr_boxplot(fill = c("blue")) + 
*geom_jitter(aes(x = 0))
```
- jitter to supplement the insight drawn from the HDR boxplot

]

.pull-right[
```{r geom-hdr-box-jitter}
```
]




---
class: top left

# Keep combining - HDR scatter + HDR marginal

.pull-left[
```r
faithful %>% 
ggplot(aes(x = waiting, y = eruptions)) +
* geom_point(aes(colour = hdr_bin(x = waiting, y = eruptions)))+
* geom_hdr_rug()
```

- Both bivariate and marginal HDRs displayed at once
- Bimodality in both marginal and bivariate distributions

]


.pull-right[

```{r combo}
```
]

---

# Authors of gghdr

```{r authors}

```

---
class: middle top

#  More Information

Package: https://github.com/ropenscilabs/gghdr  

Slides: https://sayanigupta-useR2020.netlify.com/  

Materials: https://github.com/Sayani07/useR2020    

.small[.small[
https://ggplot2-book.org/programming.html
https://www.youtube.com/watch?v=h29g21z0a68
https://www.youtube.com/watch?v=0m4yywqNPVY
https://yjunechoe.github.io/posts/2020-09-26-demystifying-stat-layers-ggplot2/
https://mran.microsoft.com/snapshot/2015-12-28/web/packages/ggplot2/vignettes/extending-ggplot2.html

]
]

Slides created with <i> Rmarkdown, knitr, xaringan, xaringanthemer</i>
